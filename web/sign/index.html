<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Sign up realm for Bruderschaft Weight Loss">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BWL Sign Up</title>
    <link href="./web/@teqfw/ui-quasar/styles.css" rel="stylesheet" type="text/css">
    <link href="./src/quasar/quasar.prod.css" rel="stylesheet" type="text/css">

    <script>
        async function bootstrap() {
            const API = './api';
            const REALM = 'sign';

            // DEFINE INNER FUNCTIONS
            /**
             * Import code, create and setup Dependency Injection container for frontend.
             *
             * @returns {Promise<TeqFw_Di_Container>}
             */
            async function initDiContainer() {

                // DEFINE INNER FUNCTIONS
                /**
                 * @returns {Promise<TeqFw_Core_App_Shared_Service_Route_Load_Namespaces_Response>}
                 */
                async function loadNamespaces() {
                    // load frontend configuration and user profile
                    const res = await fetch(`./${API}/core/load/namespaces`);
                    const json = await res.json();
                    return json.data;
                }

                // MAIN FUNCTIONALITY
                const baseUrl = `${location.origin}/${REALM}`;
                // create and setup DI Container
                const modContainer = await import('./src/@teqfw/di/Container.mjs');
                /** @type {TeqFw_Di_Container} */
                const result = new modContainer.default();
                const response = await loadNamespaces();
                if (response && response.items) {
                    for (const key of Object.keys(response.items)) {
                        const item = response.items[key];
                        result.addSourceMapping(item.ns, baseUrl + item.path, true, item.ext);
                    }
                }
                return result;
            }

            /**
             * Load frontend configuration from API using simple 'fetch'.
             *
             * @param {TeqFw_Di_Container} container
             * @returns {Promise<TeqFw_Core_App_Front_Data_Config>}
             */
            async function loadConfig(container) {
                // load frontend configuration and user profile
                const res = await fetch(`./${API}/core/load/config`);
                const json = await res.json();
                const DConfig = await container.get('TeqFw_Core_App_Front_Data_Config#'); // class constructor
                /** @type {TeqFw_Core_App_Front_Data_Config} */
                const result = Object.assign(new DConfig(), json.data);
                result.realm = REALM;
                return result;
            }

            /**
             * Initialize 'i18next' library to use internationalization and add translate function '$t' to Vue app's
             * global properties.
             *
             * @param {TeqFw_Di_Container} container
             * @param {Object} app Vue application
             * @param {Object} i18next
             * @param {Function} i18nBld browser language detection function
             * @returns {Promise<Object>}
             */
            async function initI18n(container, app, i18next, i18nBld) {
                const gate = await container.get('TeqFw_Core_App_Front_Gate_Load_I18n$');
                /** @type {typeof TeqFw_Core_App_Shared_Service_Route_Load_I18n_Request} */
                const Request = await container.get('TeqFw_Core_App_Shared_Service_Route_Load_I18n#Request');
                const resources = await gate(new Request());
                i18next.use(i18nBld);
                await i18next.init({resources, defaultNS: 'app'});
                // add '$t' translation function to Vue app
                const appProps = app.config.globalProperties;
                appProps.$t = (key, options) => i18next.t(key, options);
                return i18next;
            }

            /**
             * Create and initialize Vue3 router.
             *
             * @returns {*}
             */
            function initRouter(VueRouter) {
                return VueRouter.createRouter({
                    history: VueRouter.createWebHashHistory(),
                    routes: []
                });
            }

            /**
             * Init Vuex store and add it to Vue application.
             *
             * @param {Object} app
             * @param {TeqFw_Di_Container} container
             * @param {Fl32_Bwl_Defaults} DEF
             * @param {Object} Vuex
             */
            async function initVuex(app, container, DEF, Vuex) {
                /** @type {Fl32_Bwl_Front_Realm_Sign_State} */
                const state = await container.get('Fl32_Bwl_Front_Realm_Sign_State$'); // object singleton
                const store = Vuex.createStore(state);
                container.set(DEF.DI_STORE, store);
                app.use(store);
            }

            async function initSession(container, DEF) {
                // setup session (load user permissions from server)
                /** @type {Fl32_Teq_User_Front_App_Session} */
                const session = await container.get('Fl32_Teq_User_Front_App_Session$'); // instance singleton
                session.setRouteToSignIn(DEF.ROUTE_SIGN_IN);
                await session.init();
                container.set(DEF.MOD_USER.DI_SESSION, session);    // TMP: put into container as singleton
            }

            // MAIN FUNCTIONALITY
            try {
                // initialize objects loader (Dependency Injection container)
                const container = await initDiContainer();
                /** @type {Fl32_Bwl_Defaults} */
                const DEF = await container.get('Fl32_Bwl_Defaults$');  // instance singleton
                // load configuration from server and place it into DI container
                const config = await loadConfig(container);
                container.set(DEF.MOD_CORE.DI_CONFIG, config);
                container.set('config', config); // TODO: for user module compatibility (need to change in future)
                // save old-style loaded JS objects into DI container (see <script src="..."> at the end of HTML)
                container.set(DEF.MOD_VUE.DI_VUE, self.Vue);
                container.set(DEF.MOD_VUE.DI_VUEX, self.Vuex);
                container.set(DEF.DI_CHART, self.Chart); // https://www.chartjs.org/
                // create vue application, init router and i18n
                const app = self.Vue.createApp({});
                const router = initRouter(self.VueRouter);
                container.set(DEF.MOD_VUE.DI_ROUTER, router);
                const i18next = await initI18n(container, app, self.i18next, self.i18nextBrowserLanguageDetector);
                container.set(DEF.MOD_VUE.DI_APP, app);
                container.set(DEF.MOD_CORE.DI_I18N, i18next);
                app.use(self.Quasar, {config: {}});
                self.Quasar.iconSet.set(self.Quasar.iconSet.svgMaterialIcons);
                container.set(DEF.MOD_QUASAR.DI_QUASAR, self.Quasar);
                await initVuex(app, container, DEF, self.Vuex);
                await initSession(container, DEF);
                // load root component and mount frontend application to DOM
                const appRoot = await container.get('Fl32_Bwl_Front_Realm_Sign_App$$');   // new component
                app.component('appRoot', appRoot);
                // mount Vue application to the page
                app.mount('BODY > DIV');
            } catch (e) {
                console.error("Error in bootstrap: " + e + "\n" + e.stack);
            }
        }
        // we have no Service Worker here, registration is online only functionality
        self.addEventListener("load", bootstrap);
    </script>
</head>
<body>
<div>
    <app-root></app-root>
</div>
<!-- These scripts are not ESM ready for loading with ES6 'import'. Use old style loading.  -->
<script type="application/javascript" src="./src/vue/vue.global.js"></script>
<script type="application/javascript" src="./src/vue-router/vue-router.global.js"></script>
<script type="application/javascript" src="./src/vuex/vuex.global.js"></script>
<script type="application/javascript" src="./src/i18next/i18next.min.js"></script>
<script type="application/javascript" src="./src/i18next-detect/i18nextBrowserLanguageDetector.js"></script>
<script type="application/javascript" src="./src/quasar/quasar.umd.prod.js"></script>
<script type="application/javascript" src="./src/quasar/icon-set/svg-material-icons.umd.prod.js"></script>

<!-- load application styles -->
<link rel="stylesheet" href="styles.css">
</body>
</html>
